<div class="flex flex-col flex-auto border-l overflow-hidden bg-gray-50 h-96 dark:bg-transparent">
	<ng-container *ngIf="chatRoom() as chat; else selectChatOrStartNew">
		<div
			*ngIf="otherUser() as otherUser"
			class="flex flex-col-reverse overflow-y-auto overscroll-y-contain"
		>
			<div class="flex flex-col flex-auto shrink p-6">
				<ng-container
					*ngFor="
						let message of chat.messages;
						let i = index;
						let first = first;
						let last = last;
						trackBy: userMessageTrackByFn
					"
				>
					<!-- Start of the day -->
					<ng-container
						*ngIf="
							first ||
							(chat.messages[i - 1].messageSentTime | standaloneDate : 'd') !==
								(message.messageSentTime | standaloneDate : 'd')
						"
					>
						<div class="flex items-center justify-center my-3 -mx-6">
							<div class="flex-auto border-b"></div>
							<div class="flex-0 mx-4 text-sm font-medium leading-5 text-secondary">
								{{ message.messageSentTime | standaloneDate : "longDate" }}
							</div>
							<div class="flex-auto border-b"></div>
						</div>
					</ng-container>
					<div
						[ngClass]="{
							'items-end': message.isUserSender,
							'items-start': !message.isUserSender,
							'mt-3': i > 0 && chat.messages[i - 1].isUserSender === message.isUserSender,
							'mt-4': last && !message.isUserSender,
							'mt-5': i > 0 && chat.messages[i - 1].isUserSender !== message.isUserSender
						}"
						class="flex flex-col"
					>
						<!-- Bubble -->
						<div
							[ngClass]="{
								'bg-blue-500 text-blue-50': message.isUserSender,
								'bg-gray-500 text-gray-50': !message.isUserSender
							}"
							class="relative max-w-3/4 px-3 py-2 rounded-lg"
						>
							<!--							<p
															*ngIf="last || chat.messages[i + 1].isUserSender !== message.isUserSender"
															class="absolute top-0 left-0 right-0 -mt-4 text-xs text-gray-500 font-medium text-secondary"
														>
															{{ message.isUserSender ? "You" : otherUser.displayName }}
														</p>-->
							<p
								*ngIf="last && !message.isUserSender"
								class="absolute top-0 left-0 right-0 pl-1 -mt-4 text-xs text-gray-500 font-medium text-secondary"
							>
								{{ otherUser.displayName }}
							</p>
							<!--							<auth-web-user-avatar
															*ngIf="!message.isUserSender"
															[ngClass]="{
																'absolute bottom-0 right-0 mb-1 mr-1': message.isUserSender,
																'absolute bottom-0 left-0 mb-1 ml-1': !message.isUserSender
															}"
															[user]="otherUser"
														/>-->
							<!-- Speech bubble tail -->
							<ng-container
								*ngIf="last || chat.messages[i + 1].isUserSender !== message.isUserSender"
							>
								<div
									[ngClass]="{
										'text-blue-500 -right-1 -mr-px mb-px': message.isUserSender,
										'text-gray-500 -left-1 -ml-px mb-px -scale-x-1': !message.isUserSender
									}"
									class="absolute bottom-0 w-3"
								>
									<ng-container *ngTemplateOutlet="speechBubbleExtension"></ng-container>
								</div>
							</ng-container>
							<!-- Message -->
							<div [innerHTML]="message.content" class="min-w-4 leading-5"></div>
						</div>
						<!-- Time -->
						<ng-container
							*ngIf="
								first ||
								last ||
								chat.messages[i + 1].isUserSender !== message.isUserSender ||
								chat.messages[i + 1].messageSentTime !== message.messageSentTime
							"
						>
							<div
								[ngClass]="{ 'mr-3': message.isUserSender, 'ml-3': !message.isUserSender }"
								class="my-0.5 text-xs font-medium text-secondary"
							>
								{{ message.messageSentTime | standaloneDate : "HH:mm" }}
							</div>
						</ng-container>
					</div>
				</ng-container>
			</div>
		</div>

		<!--		<div class="absolute bottom-0 left-0 right-0 ">-->
		<div class="mt-2 p-1 flex rounded-md shadow-sm">
			<div class="relative flex flex-grow items-stretch focus-within:z-10">
				<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
					<svg
						aria-hidden="true"
						class="h-5 w-5 text-gray-400"
						fill="currentColor"
						viewBox="0 0 20 20"
					>
						<path
							d="M7 8a3 3 0 100-6 3 3 0 000 6zM14.5 9a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM1.615 16.428a1.224 1.224 0 01-.569-1.175 6.002 6.002 0 0111.908 0c.058.467-.172.92-.57 1.174A9.953 9.953 0 017 18a9.953 9.953 0 01-5.385-1.572zM14.5 16h-.106c.07-.297.088-.611.048-.933a7.47 7.47 0 00-1.588-3.755 4.502 4.502 0 015.874 2.636.818.818 0 01-.36.98A7.465 7.465 0 0114.5 16z"
						/>
					</svg>
				</div>
				<input
					#messageInput
					(keyup)="onMessageBoxKeyUp($event, messageInput)"
					class="block w-full rounded-none rounded-l-md border-0 py-1.5 pl-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
					id="message"
					name="message"
					placeholder="Send a message"
					type="text"
				/>
			</div>
			<button
				(click)="sendMessageToUserFromButton(messageInput)"
				class="-ml-px flex items-center justify-center gap-x-1.5 rounded-r-md px-6 py-3 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
				type="button"
			>
				<svg-input class="-ml-0.5 h-5 w-5 text-gray-400" svgName="SvgPaperAirplane" />
			</button>
		</div>
		<!--		</div>-->
	</ng-container>
</div>

<ng-template #selectChatOrStartNew>
	<div class="flex flex-col flex-auto items-center justify-center w-full h-full p-4">
		<!--		<mat-icon
					[svgIcon]="'heroicons_outline:chat-bubble-bottom-center-text'"
					class="icon-size-24"
				></mat-icon>-->
		<svg-input svgName="SvgChatBubbleLeft" />
		<div class="mt-4 text-xl text-center font-medium tracking-tight text-secondary">
			Select a conversation
		</div>
	</div>
</ng-template>

<ng-template #speechBubbleExtension>
	<svg height="100%" viewBox="0 0 66 66" width="100%" xmlns="http://www.w3.org/2000/svg">
		<g fill="none" fill-rule="evenodd" id="Page-1" stroke="none" stroke-width="1">
			<path
				d="M1.01522827,0.516204834 C-8.83532715,54.3062744 61.7609863,70.5215302 64.8009949,64.3061218 C68.8074951,54.8859711 30.1663208,52.9997559 37.5036011,0.516204834 L1.01522827,0.516204834 Z"
				fill="currentColor"
				fill-rule="nonzero"
			></path>
		</g>
	</svg>
</ng-template>
