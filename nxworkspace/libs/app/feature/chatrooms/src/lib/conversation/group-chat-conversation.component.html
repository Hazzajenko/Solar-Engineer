<ng-container *ngIf='user$ | async as user'>
  <!--  <ng-container *ngIf='messages$ | async as messages'>-->
  <ng-container *ngIf='groupChatMessages$ | async as groupChatMessages'>
    <ng-container *ngrxLet='isDialog$ | async as isDialog'>
      <div
        class='flex flex-col items-center content-center'>
        <!--            <h1 mat-dialog-title>{{recipient}}</h1>-->
        <!--        [ngStyle]='{
                "height": isDialog ? "550px" : "550px"
                }'-->
        <!--        [style.height]='calculateContainerHeight(conversationMessages, viewport)'-->
        <cdk-virtual-scroll-viewport
          [ngStyle]='{
                "height": isDialog ? "550px" : "550px"
                }'
          
          appScrollViewportDirective
          #viewport
          (scrolledIndexChange)='scrollIndex = $event'
          [scrollIndex]='scrollIndex'
          [viewport]='viewport'
          [isGroup]='true'
          [groupChatMessages]='groupChatMessages'
          style='overflow-y: scroll '
          itemSize='25'
          class='flex w-[100%] min-w-max'>
          <!--        column-reverse;-->
          <!--   (scroll)='scrolled($event)'-->
          <!--          [ngStyle]='{"background-color": notification.status === 0 ? "#60a1fa" : ""}'-->
          <div appConversationMessageDirective
               [username]='user.username'
               [groupChatMessage]='message'

               class='flex grow'
               *cdkVirtualFor='let message of groupChatMessages'>


            <ng-container [ngSwitch]='true'>
              <ng-container *ngSwitchCase='user.username === message.senderUsername'>
                <div
                  (click)='selectGroupChatMessage(message)'
                  [ngClass]='{
                      "bg-blue-400/75": selectedGroupChatMessage?.id === message.id,
                      "hover:bg-blue-400": selectedGroupChatMessage?.id === message.id,
                      "hover:bg-sky-400": selectedGroupChatMessage?.id !== message.id
                      }'
                  class='flex flex-col my-2 p-1 min-w-[250px] max-w-[250px] rounded-tl-lg rounded-tr-lg rounded-bl-lg bg-sky-400/75  mx-5'>
                  <!--                      <span matListItemTitle>{{message.senderUsername}}</span>-->

                  <span
                    *ngIf='selectedGroupChatMessage && selectedGroupChatMessage.id === message.id && message.id !== groupChatMessages[groupChatMessages.length-1].id'
                    matListItemLine>{{message.messageSentTime | date : 'short'}}</span>
                  <p style='white-space: pre-line' matListItemLine>{{message.content}}</p>
                  <span *ngIf='message.id === groupChatMessages[groupChatMessages.length-1].id'
                        matListItemLine>Sent {{message.messageSentTime | date : 'short'}}</span>
                  <!--                 <span *ngIf='message.messageReadTime && message.id === lastMessageId'
                                         matListItemLine>Seen {{message.messageReadTime | date : 'short'}}</span>-->
                </div>
              </ng-container>
              <ng-container *ngSwitchCase='user.username !== message.senderUsername'>
                <div
                  (click)='selectGroupChatMessage(message)'
                  class='flex flex-col my-2 p-1 min-w-[250px] max-w-[250px] rounded-lg bg-gray-400/75 hover:bg-gray-400 mx-5'>
                  <span matListItemTitle>{{message.senderUsername}}</span>
                  <span
                    *ngIf='selectedGroupChatMessage && selectedGroupChatMessage.id === message.id && message.id !== groupChatMessages[groupChatMessages.length-1].id'
                    matListItemLine>{{message.messageSentTime | date : 'short'}}</span>
                  <p style='white-space: pre-line' matListItemLine>{{message.content}}</p>
                  <span *ngIf='message.id === groupChatMessages[groupChatMessages.length-1].id'
                        matListItemLine>Sent {{message.messageSentTime | date : 'short'}}</span>
                  <!--            <span *ngIf='message.id === lastMessageId && message.messageReadTime'
                                    matListItemLine>Seen By You {{message.messageReadTime | date : 'short'}}</span>-->
                </div>
              </ng-container>
            </ng-container>

          </div>
        </cdk-virtual-scroll-viewport>

        <form class='min-w-max w-[100%] grow-0'>
          <label for='chat' class='sr-only'>Your message</label>
          <div class='flex items-center px-3 py-2 rounded-lg'>
            <button type='button'
                    class='inline-flex justify-center p-2 text-gray-500 rounded-lg cursor-pointer hover:text-gray-900 hover:bg-gray-100'>
              <svg aria-hidden='true' class='w-6 h-6' fill='currentColor' viewBox='0 0 20 20'
                   xmlns='http://www.w3.org/2000/svg'>
                <path fill-rule='evenodd'
                      d='M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z'
                      clip-rule='evenodd'></path>
              </svg>
              <span class='sr-only'>Upload image</span>
            </button>
            <button type='button'
                    class='p-2 text-gray-500 rounded-lg cursor-pointer hover:text-gray-900 hover:bg-gray-100'>
              <svg aria-hidden='true' class='w-6 h-6' fill='currentColor' viewBox='0 0 20 20'
                   xmlns='http://www.w3.org/2000/svg'>
                <path fill-rule='evenodd'
                      d='M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z'
                      clip-rule='evenodd'></path>
              </svg>
              <span class='sr-only'>Add emoji</span>
            </button>
            <textarea id='chat'
                      #autosize='cdkTextareaAutosize'
                      cdkTextareaAutosize
                      [cdkAutosizeMinRows]='3'
                      [cdkAutosizeMaxRows]='3'
                      [formControl]='messageControl'
                      class='block mx-4 p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500'
                      placeholder='Your message...'></textarea>
            <button type='submit' (click)='sendGroupChatMessage()'
                    class='inline-flex justify-center p-2 text-blue-600 rounded-full cursor-pointer hover:bg-blue-100'>
              <svg aria-hidden='true' class='w-6 h-6 rotate-90' fill='currentColor' viewBox='0 0 20 20'
                   xmlns='http://www.w3.org/2000/svg'>
                <path
                  d='M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z'></path>
              </svg>
              <span class='sr-only'>Send message</span>
            </button>
          </div>
        </form>
      </div>
    </ng-container>
  </ng-container>
</ng-container>