<ng-container *ngIf="user$ | async as user">
  <!--  <ng-container *ngIf='messages$ | async as messages'>-->
  <ng-container *ngIf="groupChatCombined$ | async as groupChat">
    <!--    <ng-container *ngrxLet="groupChatMessages$ | async as groupChatMessages">-->
    <nav class="p-3 border-gray-200 rounded bg-gray-50">
      <div class="container flex flex-wrap items-center justify-between mx-auto">
        <a href="#" class="flex items-center">
          <!--          <img
                      src="https://flowbite.com/docs/images/logo.svg"
                      class="h-6 mr-3 sm:h-10"
                      alt="Flowbite Logo"
                    />-->
          <span class="self-center text-xl font-semibold whitespace-nowrap">{{
            groupChat.name
          }}</span>
        </a>
        <button
          data-collapse-toggle="navbar-solid-bg"
          type="button"
          class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
          aria-controls="navbar-solid-bg"
          aria-expanded="false"
        >
          <span class="sr-only">Open main menu</span>
          <svg
            class="w-6 h-6"
            aria-hidden="true"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>
        <div class="hidden w-full md:block md:w-auto" id="navbar-solid-bg">
          <ul
            class="flex flex-col mt-4 rounded-lg bg-gray-50 md:flex-row md:space-x-8 md:mt-0 md:text-sm md:font-medium"
          >
            <li>
              <a
                href="#"
                class="block py-2 pl-3 pr-4 text-white bg-blue-700 rounded md:bg-transparent md:text-blue-700 md:p-0"
                aria-current="page"
                >Members</a
              >
            </li>
            <li>
              <a
                href="#"
                class="block py-2 pl-3 pr-4 text-gray-700 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-gray-400"
                >Settings</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <ng-container *ngrxLet="isDialog$ | async as isDialog">
      <div class="flex flex-col items-center content-center">
        <!--            <h1 mat-dialog-title>{{recipient}}</h1>-->
        <!--        [ngStyle]='{
                "height": isDialog ? "550px" : "550px"
                }'-->
        <!--        [style.height]='calculateContainerHeight(conversationMessages, viewport)'-->
        <cdk-virtual-scroll-viewport
          [ngStyle]="{
            height: isDialog ? '450px' : '450px'
          }"
          appScrollViewportDirective
          #viewport
          (scrolledIndexChange)="scrollIndex = $event"
          [scrollIndex]="scrollIndex"
          [viewport]="viewport"
          [isGroup]="true"
          [groupChatMessages]="groupChat.messages"
          style="overflow-y: scroll"
          itemSize="25"
          class="flex w-[100%] min-w-max"
        >
          <!--        column-reverse;-->
          <!--   (scroll)='scrolled($event)'-->
          <!--          [ngStyle]='{"background-color": notification.status === 0 ? "#60a1fa" : ""}'-->
          <div
            appConversationMessageDirective
            [userName]="user.userName"
            [groupChatMessage]="message"
            class="flex grow"
            *cdkVirtualFor="let message of groupChat.messages"
          >
            <ng-container
              *ngrxLet="groupChat.messages[groupChat.messages.length - 1].id as lastMessageId"
            >
              <ng-container *ngIf="user.userName === message.senderUserName; else recipientMessage">
                <div
                  (click)="selectGroupChatMessage(message)"
                  [ngClass]="{
                    'bg-blue-400/75': selectedGroupChatMessage?.id === message.id,
                    'hover:bg-blue-400': selectedGroupChatMessage?.id === message.id,
                    'hover:bg-sky-400': selectedGroupChatMessage?.id !== message.id
                  }"
                  class="flex flex-col my-2 p-1 min-w-[250px] max-w-[250px] rounded-tl-lg rounded-tr-lg rounded-bl-lg bg-sky-400/75 mx-5"
                >
                  <!--                      <span matListItemTitle>{{message.senderUsername}}</span>-->

                  <span
                    *ngIf="
                      selectedGroupChatMessage &&
                      selectedGroupChatMessage.id === message.id &&
                      message.id !== lastMessageId
                    "
                    >{{ message.messageSentTime | date: "short" }}</span
                  >
                  <p style="white-space: pre-line">{{ message.content }}</p>
                  <span *ngIf="message.id === lastMessageId"
                    >Sent {{ message.messageSentTime | date: "short" }}</span
                  >
                  <br />
                  <span
                    style="clear: left"
                    *ngIf="
                      (message.messageReadTimes | anyGroupMessageSeen: user.userName) &&
                      message.id === lastMessageId
                    "
                  >
                    Seen by
                    <ng-container
                      *ngIf="selectedGroupChatMessage?.id === message.id; else notSelected"
                    >
                      <div
                        style="margin-left: 2px"
                        *ngFor="
                          let readTime of message.messageReadTimes
                            | excludeUserFromSeen: user.userName
                        "
                      >
                        {{ readTime.recipientUserName }}
                        {{ readTime.messageReadTime | date: "short" }}
                        {{
                          readTime.id !==
                          message.messageReadTimes[message.messageReadTimes.length - 1].id
                            ? ","
                            : ""
                        }}
                        <!-- {{readTime.messageReadTime | date : 'short'}}-->
                      </div>
                    </ng-container>
                    <ng-template #notSelected>
                      <span
                        style="clear: left"
                        *ngFor="
                          let readTime of message.messageReadTimes
                            | excludeUserFromSeen: user.userName
                        "
                      >
                        {{ readTime.recipientUserName }}
                        {{
                          readTime.id !==
                          message.messageReadTimes[message.messageReadTimes.length - 1].id
                            ? ","
                            : ""
                        }}
                        <!-- {{readTime.messageReadTime | date : 'short'}}-->
                      </span>
                    </ng-template>
                  </span>
                </div>
              </ng-container>
              <!--                *ngrxLet='message.senderUsername | isMemberOnline : groupChatMembers as isOnline'-->
              <ng-template #recipientMessage>
                <div
                  (click)="selectGroupChatMessage(message)"
                  (contextmenu)="onRightClick($event, message)"
                  class="flex flex-col my-2 p-1 min-w-[250px] max-w-[250px] rounded-lg bg-gray-400/75 hover:bg-gray-400 mx-5"
                >
                  <span class="flex" matListItemTitle>
                    <mat-icon
                      color="primary"
                      style="transform: scale(0.75)"
                      *ngIf="message.sender.isOnline"
                      >wifi</mat-icon
                    >
                    <img
                      mat-card-avatar
                      width="25px"
                      height="25px"
                      [src]="message.sender.photoUrl"
                      alt=""
                    />
                    {{ message.senderUserName }}
                    <!--{{message.sender.isOnline ? 'ONLINE' : ''}}-->
                  </span>
                  <span
                    *ngIf="
                      selectedGroupChatMessage &&
                      selectedGroupChatMessage.id === message.id &&
                      message.id !== lastMessageId
                    "
                    matListItemLine
                    >{{ message.messageSentTime | date: "short" }}</span
                  >
                  <p style="white-space: pre-line" matListItemLine>{{ message.content }}</p>
                  <span *ngIf="message.id === lastMessageId"
                    >Sent {{ message.messageSentTime | date: "short" }}</span
                  >
                  <br />
                  <span
                    style="clear: left"
                    *ngIf="
                      (message.messageReadTimes | anyGroupMessageSeen: user.userName) &&
                      message.id === lastMessageId
                    "
                  >
                    Seen by
                    <ng-container
                      *ngIf="selectedGroupChatMessage?.id === message.id; else notSelected"
                    >
                      <div
                        style="margin-left: 2px"
                        *ngFor="
                          let readTime of message.messageReadTimes
                            | excludeUserFromSeen: user.userName
                        "
                      >
                        {{ readTime.recipientUserName }}
                        {{ readTime.messageReadTime | date: "short" }}
                        {{
                          readTime.id !==
                          message.messageReadTimes[message.messageReadTimes.length - 1].id
                            ? ","
                            : ""
                        }}
                        <!-- {{readTime.messageReadTime | date : 'short'}}-->
                      </div>
                    </ng-container>
                    <ng-template #notSelected>
                      <span
                        style="clear: left"
                        *ngFor="
                          let readTime of message.messageReadTimes
                            | excludeUserFromSeen: user.userName
                        "
                      >
                        {{ readTime.recipientUserName }}
                        {{
                          readTime.id !==
                          message.messageReadTimes[message.messageReadTimes.length - 1].id
                            ? ","
                            : ""
                        }}
                        <!-- {{readTime.messageReadTime | date : 'short'}}-->
                      </span>
                    </ng-template>
                  </span>

                  <!--            <span *ngIf='message.id === lastMessageId && message.messageReadTime'
                                    matListItemLine>Seen By You {{message.messageReadTime | date : 'short'}}</span>-->
                </div>
              </ng-template>
            </ng-container>
          </div>
        </cdk-virtual-scroll-viewport>
        <app-message-bar-component
          class="min-w-max w-[100%] grow-0"
          (sendMessageEvent)="sendGroupChatMessage($event)"
        ></app-message-bar-component>
      </div>
    </ng-container>
    <!--    </ng-container>-->
  </ng-container>
</ng-container>

<div
  [matMenuTriggerFor]="rightMenu"
  [style.left]="menuTopLeftPosition.x"
  [style.top]="menuTopLeftPosition.y"
  style="visibility: hidden; position: fixed"
></div>

<mat-menu #rightMenu="matMenu">
  <ng-template matMenuContent>
    <app-group-chat-message-menu-component
      *ngIf="selectedGroupChatMessage"
      [message]="selectedGroupChatMessage"
    ></app-group-chat-message-menu-component>
  </ng-template>
</mat-menu>
