<ng-container *ngIf="user$ | async as user">
  <!--  <ng-container *ngIf='messages$ | async as messages'>-->
  <ng-container *ngIf="groupChatCombined$ | async as groupChat">
    <!--    <ng-container *ngrxLet="groupChatMessages$ | async as groupChatMessages">-->
    <app-group-chat-options-bar-component
      [groupChat]="groupChat"
    ></app-group-chat-options-bar-component>
    <ng-container *ngrxLet="isDialog$ | async as isDialog">
      <div class="flex flex-col items-center content-center">
        <cdk-virtual-scroll-viewport
          [ngStyle]="{
            height: isDialog ? '450px' : '450px'
          }"
          appScrollViewportDirective
          #viewport
          (scrolledIndexChange)="scrollIndex = $event"
          [scrollIndex]="scrollIndex"
          [viewport]="viewport"
          [isGroup]="true"
          [groupChatMessages]="groupChat.messages"
          style="overflow-y: scroll"
          itemSize="25"
          class="flex w-[100%] min-w-max"
        >
          <div
            appConversationMessageDirective
            [userName]="user.userName"
            [groupChatMessage]="message"
            class="flex grow"
            *cdkVirtualFor="let message of groupChat.messages; trackBy: trackByFn"
          >
            <ng-container
              *ngrxLet="groupChat.messages[groupChat.messages.length - 1].id as lastMessageId"
            >
              <ng-container
                *ngIf="message.messageFrom === MessageFrom.Server; else notServerMessage"
              >
                <!--              <ng-container
                                *ngIf="
                                  message.sender.isServer && message.sender.role === 'SERVER';
                                  else notServerMessage
                                "
                              >-->
                <div>
                  {{ message.content }}
                </div>
              </ng-container>
              <ng-template #notServerMessage>
                <!--                  *ngIf="user.userName === message.senderUserName; else recipientMessage"-->
                <ng-container
                  *ngIf="message.messageFrom === MessageFrom.CurrentUser; else recipientMessage"
                >
                  <div
                    (click)="selectGroupChatMessage(message)"
                    [ngClass]="{
                      'bg-blue-400/75': selectedGroupChatMessage?.id === message.id,
                      'hover:bg-blue-400': selectedGroupChatMessage?.id === message.id,
                      'hover:bg-sky-400': selectedGroupChatMessage?.id !== message.id
                    }"
                    class="flex flex-col my-2 p-1 min-w-[250px] max-w-[250px] rounded-tl-lg rounded-tr-lg rounded-bl-lg bg-sky-400/75 mx-5"
                  >
                    <!--                      <span matListItemTitle>{{message.senderUsername}}</span>-->

                    <span
                      *ngIf="
                        selectedGroupChatMessage &&
                        selectedGroupChatMessage.id === message.id &&
                        message.id !== lastMessageId
                      "
                      >{{ message.messageSentTime | date: "short" }}</span
                    >
                    <p style="white-space: pre-line">{{ message.content }}</p>
                    <span *ngIf="message.id === lastMessageId"
                      >Sent {{ message.messageSentTime | date: "short" }}</span
                    >
                    <br />
                    <span
                      style="clear: left"
                      *ngIf="
                        (message.messageReadTimes | anyGroupMessageSeen: user.userName) &&
                        message.id === lastMessageId
                      "
                    >
                      Seen by
                      <ng-container
                        *ngIf="selectedGroupChatMessage?.id === message.id; else notSelected"
                      >
                        <div
                          style="margin-left: 2px"
                          *ngFor="
                            let readTime of message.messageReadTimes
                              | excludeUserFromSeen: user.userName
                          "
                        >
                          {{ readTime.recipientUserName }}
                          {{ readTime.messageReadTime | date: "short" }}
                          {{
                            readTime.id !==
                            message.messageReadTimes[message.messageReadTimes.length - 1].id
                              ? ","
                              : ""
                          }}
                          <!-- {{readTime.messageReadTime | date : 'short'}}-->
                        </div>
                      </ng-container>
                      <ng-template #notSelected>
                        <span
                          style="clear: left"
                          *ngFor="
                            let readTime of message.messageReadTimes
                              | excludeUserFromSeen: user.userName
                          "
                        >
                          {{ readTime.recipientUserName }}
                          {{
                            readTime.id !==
                            message.messageReadTimes[message.messageReadTimes.length - 1].id
                              ? ","
                              : ""
                          }}
                          <!-- {{readTime.messageReadTime | date : 'short'}}-->
                        </span>
                      </ng-template>
                    </span>
                  </div>
                </ng-container>
                <!--                *ngrxLet='message.senderUsername | isMemberOnline : groupChatMembers as isOnline'-->
                <ng-template #recipientMessage>
                  <div
                    (click)="selectGroupChatMessage(message)"
                    (contextmenu)="onRightClick($event, message)"
                    class="flex flex-col my-2 p-1 min-w-[250px] max-w-[250px] rounded-lg bg-gray-400/75 hover:bg-gray-400 mx-5"
                  >
                    <span class="flex" matListItemTitle>
                      <mat-icon
                        color="primary"
                        style="transform: scale(0.75)"
                        *ngIf="message.sender.isOnline"
                        >wifi</mat-icon
                      >
                      <img
                        mat-card-avatar
                        width="25px"
                        height="25px"
                        [src]="message.sender.photoUrl"
                        alt=""
                      />
                      {{ message.senderUserName }}
                      <!--{{message.sender.isOnline ? 'ONLINE' : ''}}-->
                    </span>
                    <span
                      *ngIf="
                        selectedGroupChatMessage &&
                        selectedGroupChatMessage.id === message.id &&
                        message.id !== lastMessageId
                      "
                      matListItemLine
                      >{{ message.messageSentTime | date: "short" }}</span
                    >
                    <p style="white-space: pre-line" matListItemLine>{{ message.content }}</p>
                    <span *ngIf="message.id === lastMessageId"
                      >Sent {{ message.messageSentTime | date: "short" }}</span
                    >
                    <br />
                    <span
                      style="clear: left"
                      *ngIf="
                        (message.messageReadTimes | anyGroupMessageSeen: user.userName) &&
                        message.id === lastMessageId
                      "
                    >
                      Seen by
                      <ng-container
                        *ngIf="selectedGroupChatMessage?.id === message.id; else notSelected"
                      >
                        <div
                          style="margin-left: 2px"
                          *ngFor="
                            let readTime of message.messageReadTimes
                              | excludeUserFromSeen: user.userName
                          "
                        >
                          {{ readTime.recipientUserName }}
                          {{ readTime.messageReadTime | date: "short" }}
                          {{
                            readTime.id !==
                            message.messageReadTimes[message.messageReadTimes.length - 1].id
                              ? ","
                              : ""
                          }}
                          <!-- {{readTime.messageReadTime | date : 'short'}}-->
                        </div>
                      </ng-container>
                      <ng-template #notSelected>
                        <span
                          style="clear: left"
                          *ngFor="
                            let readTime of message.messageReadTimes
                              | excludeUserFromSeen: user.userName
                          "
                        >
                          {{ readTime.recipientUserName }}
                          {{
                            readTime.id !==
                            message.messageReadTimes[message.messageReadTimes.length - 1].id
                              ? ","
                              : ""
                          }}
                          <!-- {{readTime.messageReadTime | date : 'short'}}-->
                        </span>
                      </ng-template>
                    </span>

                    <!--            <span *ngIf='message.id === lastMessageId && message.messageReadTime'
                                      matListItemLine>Seen By You {{message.messageReadTime | date : 'short'}}</span>-->
                  </div>
                </ng-template>
              </ng-template>
            </ng-container>
          </div>
        </cdk-virtual-scroll-viewport>
        <app-message-bar-component
          class="min-w-max w-[100%] grow-0"
          (sendMessageEvent)="sendGroupChatMessage($event)"
        ></app-message-bar-component>
      </div>
    </ng-container>
    <!--    </ng-container>-->
  </ng-container>
</ng-container>

<div
  [matMenuTriggerFor]="rightMenu"
  [style.left]="menuTopLeftPosition.x"
  [style.top]="menuTopLeftPosition.y"
  style="visibility: hidden; position: fixed"
></div>

<mat-menu #rightMenu="matMenu">
  <ng-template matMenuContent>
    <app-group-chat-message-menu-component
      *ngIf="selectedGroupChatMessage"
      [message]="selectedGroupChatMessage"
    ></app-group-chat-message-menu-component>
  </ng-template>
</mat-menu>
